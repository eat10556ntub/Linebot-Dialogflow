# F-02 加入會員


## (1) 在DialogFlow新增以下意圖
```
|__ Intents
|      |
|      |__ customer join (加入會員)
.             |
.             |__ Training Phrases
.             |        |__ 我想加入會員
.             |        |__ 我想參加會員
.             |        |__ 想加入會員
.             |        |__ 想參加會員
.             |        |__ 加入會員
.             |        |__ 參加會員
.             |
.             |__ Responses
.             |        |__ 加入會員樣版回覆, 看到這串文字表示程式有錯.
.             |        
.             |__ Fulfillment
.                      |__ Enable webhook call for this intent (開啟, 變成藍色)
.
|__ Fulfillment     
       |__ Webhook (啟動 ENABLED, 變成藍色)    
              |__ URL*  -->  https://自己在Heroku的應用程式名稱.herokuapp.com/dialogflow     
```


## (2) 程式結構
``` js
   |__ <utility>
   |      |__ asyncDB.js
   |      |__ customer.js
   |
   |__ index.js
   |__ package.json

```

## (3) asyncDB.js  (記得修改連線資料)

``` js
'use strict';

//-----------------------
// 引用資料庫模組
//-----------------------
const {Client} = require('pg');

//-----------------------
// 自己的資料庫連結位址
//-----------------------
var pgConn = 'postgres://填入自己的資料';

//產生可同步執行query物件的函式
function query(sql, value=null) {
    return new Promise((resolve, reject) => {
        //設定資料庫連線物件
        var client = new Client({
            connectionString: pgConn,
            ssl: true
        })     

        //連結資料庫
        client.connect();

        //回覆查詢結果  
        client.query(sql, value, (err, results) => {                   
            if (err){
                reject(err);
            }else{
                resolve(results);
            }

            //關閉連線
            client.end();
        });
    });
}

//-----------------------
// 匯出函式
//-----------------------
module.exports = query;
```


## (4) customer.js

``` js
'use strict';

//引用操作資料庫的物件
const query = require('./asyncDB');

//---------------------------------
// 加入會員 (寫id到customer資料表)
//---------------------------------
var add = async function(cusid){
    //存放結果
    let result;  

    //寫入資料表
    await query('INSERT INTO customer (id) VALUES ($1)', [cusid])
        .then((data) => {
            result = 0;   //寫入成功
        }, (error) => {
            result = -9;  //寫入錯誤
        });

    //回傳執行結果
    return result;  
}

//-----------------------
// 匯出函式
//-----------------------
module.exports = {add};
```


## (5) index.js

``` js
"use strict";

const express = require('express')
const { WebhookClient } = require('dialogflow-fulfillment')
const {Text, Card, Image, Suggestion, Payload} = require('dialogflow-fulfillment'); 
const app = express()

//增加引用模組
const customer = require('./utility/customer');

//============================
// 處理各種意圖
//============================
app.post('/dialogflow', express.json(), (request, response) => {
    //回覆訊息的代理人
    const agent = new WebhookClient({request, response})

    //------------------
    // 處理歡迎意圖
    //------------------   
    function welcome(){
        //回覆文字
        agent.add('你好!!');

        agent.add('request.body:'+JSON.stringify(request.body));        
        agent.add('傳入訊息:'+request.body.queryResult.queryText);
        agent.add('action:'+request.body.queryResult.action);
        agent.add('parameters:'+request.body.queryResult.parameters);
        agent.add('userId:'+request.body.originalDetectIntentRequest.payload.data.source.userId);
        agent.add('timestamp:'+request.body.originalDetectIntentRequest.payload.data.timestamp);
    }

    //------------------
    // 處理加入會員意圖
    //------------------  
    function customerJoin(){
        //回覆文字
        agent.add('歡迎你!!');

        //取得會員的LineID
        var id = request.body.originalDetectIntentRequest.payload.data.source.userId;

        //呼叫customer模組, 寫入會員資料
        return customer.add(id).then(data => {  
            if (data == -9){
                //回覆文字
                agent.add('喔, 你的會員原本就存在!');

                //加一張貼圖
                var lineMessage = {
                    "type": "sticker",
                    "packageId": "1",
                    "stickerId": "13"
                };
                
                var payload = new Payload('LINE', lineMessage, {sendAsMessage: true});
                agent.add(payload);   
            }else if(data == 0){   
                //回覆文字            
                agent.add('會員已建立!');    
                agent.add('可填寫[姓名]及[email]收到我們的訊息!'); 
                agent.add('只要用以下格式填寫即可:'); 
                agent.add('姓名:XXX');
                agent.add('email:xxx@xxx.xxx.xxx');

                //加一張貼圖
                var lineMessage = {
                    "type": "sticker",
                    "packageId": "1",
                    "stickerId": "5"
                };
                
                var payload = new Payload('LINE', lineMessage, {sendAsMessage: true});
                agent.add(payload);                                 
            }else{
                agent.add('會員處理發生例外問題!');
            }  
        });
    }


    //-----------------------------
    // 設定對話中各個意圖的函式對照
    //-----------------------------
    let intentMap = new Map();
    
    intentMap.set('Default Welcome Intent', welcome);  //歡迎意圖
    intentMap.set('customer join', customerJoin);      //加入會員意圖

    agent.handleRequest(intentMap);
})


//----------------------------------------
// 監聽3000埠號, 
// 或是監聽Heroku設定的埠號
//----------------------------------------
var server = app.listen(process.env.PORT || 3000, function() {
    const port = server.address().port;
    console.log("正在監聽埠號:", port);
});
```


## (6) package.json

``` json
{
    "name": "myApp",
    "version": "0.0.0",
    "private": true,
    "main": "index.js",
    "scripts": {
      "start": "set NODE_TLS_REJECT_UNAUTHORIZED=0 && node ."
    },
    "dependencies": {
      "actions-on-google": "^2.4.1",
      "auth-header": "^1.0.0",
      "body-parser": "^1.18.3",
      "cookie-parser": "~1.4.3",
      "debug": "~2.6.0",
      "dialogflow": "^0.6.0",
      "dialogflow-fulfillment": "^0.6.1",
      "express": "^4.16.4",
      "pg": "^7.18.2"
    }
}
```


## (7) 安裝外掛 (不必執行npm install)

```
npm install pg --save
```


## (8) 上傳至Heroku
```
(1) 已下載及安裝Node.js (網頁)
(2) 已安裝Heroku CLI (命令: npm install heroku -g)
(3) 已下載及安裝git CLI (網頁: https://git-scm.com/downloads)
(4) 已登入Github (網頁)
(5) 已登入Line Developer (網頁)
(6) 已登入Heroku (網頁)

(假設程式在D槽的app資料夾內)
(7)  d:
     cd app
(8)  heroku login -i
(9)  (以下要輸入雙引號)
     git config --global user.email "自己在git的email帳號"
(10) git init
(11) (以下不輸入中括號)
     heroku git:remote -a [Heroku上的應用程式名稱]
---------------------------------------------------
(12) git add .
(13) git commit -am "myApp"
(14) git push heroku master -f
---------------------------------------------------
(15) 查看heroku終端機畫面
     heroku logs --tail
```
